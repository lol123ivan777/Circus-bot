// src/handlers/genres.js
const editSmart = require('../utils/editSmart');

// —Ç–≤–æ—ë –æ–ø–∏—Å–∞–Ω–∏–µ –∂–∞–Ω—Ä–æ–≤
const GENRE_DATA = {
  juggling: {
    title: 'üé™ –ñ–æ–Ω–≥–ª–∏—Ä–æ–≤–∞–Ω–∏–µ',
    text:
      '*–ñ–æ–Ω–≥–ª–∏—Ä–æ–≤–∞–Ω–∏–µ* ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –¥—Ä–µ–≤–Ω–∏—Ö —Ü–∏—Ä–∫–æ–≤—ã—Ö –∂–∞–Ω—Ä–æ–≤.\n' +
      '–ê—Ä—Ç–∏—Å—Ç—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç –≤–∏—Ä—Ç—É–æ–∑–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º—è—á–∞–º–∏, –±—É–ª–∞–≤–∞–º–∏, –∫–æ–ª—å—Ü–∞–º–∏ –∏ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏.\n\n' +
      '–°–∫–æ—Ä–æ—Å—Ç—å, —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è ‚Äî –≥–ª–∞–≤–Ω–æ–µ –≤ —ç—Ç–æ–º –∂–∞–Ω—Ä–µ.'
  },
  clown: {
    title: 'ü§° –ö–ª–æ—É–Ω–∞–¥–∞',
    text:
      '*–ö–ª–æ—É–Ω–∞–¥–∞* ‚Äî –∫–æ–º–∏—á–µ—Å–∫–∏–π –∂–∞–Ω—Ä —Ü–∏—Ä–∫–æ–≤–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞.\n' +
      '–ö–ª–æ—É–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ø—É–±–ª–∏–∫–æ–π, —Å–æ–∑–¥–∞—é—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø—Ä–∞–∑–¥–Ω–∏–∫–∞.\n\n' +
      '–Æ–º–æ—Ä, –ø–ª–∞—Å—Ç–∏–∫–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç —Å–æ –∑—Ä–∏—Ç–µ–ª–µ–º ‚Äî –æ—Å–Ω–æ–≤–∞ –∫–ª–æ—É–Ω–∞–¥—ã.'
  },
  aerial: {
    title: 'ü§∏ –í–æ–∑–¥—É—à–Ω—ã–µ –≥–∏–º–Ω–∞—Å—Ç—ã',
    text:
      '*–í–æ–∑–¥—É—à–Ω–∞—è –≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞* ‚Äî —Ä–∞–±–æ—Ç–∞ –ø–æ–¥ –∫—É–ø–æ–ª–æ–º —Ü–∏—Ä–∫–∞.\n' +
      '–ü–æ–ª–æ—Ç–Ω–∞, —Ç—Ä–∞–ø–µ—Ü–∏–∏, –∫–æ–ª—å—Ü–∞ –∏ —Ä–µ–º–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –∞—Ä—Ç–∏—Å—Ç–∞–º –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ç—Ä—é–∫–∏ –Ω–∞ –≤—ã—Å–æ—Ç–µ.\n\n' +
      '–°–∏–ª–∞, –≥–∏–±–∫–æ—Å—Ç—å –∏ —á—É–≤—Å—Ç–≤–æ –±–∞–ª–∞–Ω—Å–∞ ‚Äî –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–æ–º–µ—Ä–∞.'
  }
};

// ===== 1. –ú–ï–ù–Æ –° –ñ–ê–ù–†–ê–ú–ò =====
exports.handleGenres = async (bot, input) => {
  const text =
    'üé≠ *–ñ–∞–Ω—Ä—ã —Ü–∏—Ä–∫–æ–≤–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞*\n\n' +
    '–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä, –∞ –∑–∞—Ç–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é.';

  return editSmart(bot, input, text, {
    inline_keyboard: [
      [{ text: 'üé™ –ñ–æ–Ω–≥–ª–∏—Ä–æ–≤–∞–Ω–∏–µ', callback_data: 'genre:juggling' }],
      [{ text: 'ü§° –ö–ª–æ—É–Ω–∞–¥–∞', callback_data: 'genre:clown' }],
      [{ text: 'ü§∏ –í–æ–∑–¥—É—à–Ω—ã–µ –≥–∏–º–Ω–∞—Å—Ç—ã', callback_data: 'genre:aerial' }],
      [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', callback_data: 'back_to_menu' }]
    ]
  });
};

// ===== 2. –ü–û–ö–ê–ó –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ñ–ê–ù–†–ê =====
exports.handleGenreItem = async (bot, query) => {
  const genreId = query.data.split(':')[1];
  const genre = GENRE_DATA[genreId];

  if (!genre) {
    return editSmart(bot, query, '*–ñ–∞–Ω—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.*', {
      inline_keyboard: [
        [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data: 'genres' }]
      ]
    });
  }

  const text = `*${genre.title}*\n\n${genre.text}`;

  return editSmart(bot, query, text, {
    inline_keyboard: [
      [{ text: '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', callback_data: `genre_ai:${genreId}` }],
      [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data: 'genres' }]
    ]
  });
};

// ===== 3. –°–ü–†–û–°–ò–¢–¨ –£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ó–ê–ü–†–û–° –î–õ–Ø –ò–ò =====
exports.handleGenreAIRequest = async (bot, query) => {
  const genreId = query.data.split(':')[1];

  const text =
    '‚ú® *–ò–ò-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∂–∞–Ω—Ä–∞*\n\n' +
    '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n' +
    '_‚Äú–ñ–æ–Ω–≥–ª–µ—Ä —Å –æ–≥–Ω–µ–Ω–Ω—ã–º–∏ –±—É–ª–∞–≤–∞–º–∏‚Äù_\n\n' +
    '–ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ —è —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.';

  // —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è
  bot._waitingForPrompt = { genreId, chatId: query.message.chat.id };

  return editSmart(bot, query, text, {
    inline_keyboard: [
      [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data: `genre:${genreId}` }]
    ]
  });
};

// ===== 4. –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø –° –¢–ï–ö–°–¢–û–ú –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò =====
exports.handleGenreAIGenerate = async (bot, msg) => {
  const session = bot._waitingForPrompt;
  if (!session) return;

  if (msg.chat.id !== session.chatId) return;

  const userPrompt = msg.text;
  const genreId = session.genreId;

  bot._waitingForPrompt = null;

  const finalPrompt = `–¶–∏—Ä–∫–æ–≤–æ–π –∂–∞–Ω—Ä ${genreId}. ${userPrompt}. –°—Ç–∏–ª—å ‚Äî —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ —Ñ–æ—Ç–æ.`;

  // –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–≤–æ—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å Sorra/Gemini –ø–æ–∑–∂–µ
  // –ø–æ–∫–∞ ‚Äî –∑–∞–≥–ª—É—à–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º
  return bot.sendMessage(
    msg.chat.id,
    'üñº *–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...*\n\n(–ò–ò-–≤—Å—Ç–∞–≤–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ–∑–∂–µ)',
    { parse_mode: 'Markdown' }
  );
};